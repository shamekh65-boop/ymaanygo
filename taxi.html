<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.ico">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <title>Taxi boeken</title>

  <style>
    :root{
      --bg:#f6f6f6;
      --card:#fff;
      --text:#111;
      --muted:rgba(0,0,0,.62);
      --border:rgba(0,0,0,.10);
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --radius:18px;
      --green:#2f7d32;
      --field:#ffffff;
      --fieldBorder:rgba(0,0,0,.12);

      /* ‚úÖ one place to tune heights */
      --control-h:30px;
      --control-radius:14px;
      --control-font:16px;
    }

    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;color:var(--text)}
    a{color:inherit;text-decoration:none}
    .hidden{display:none !important}

    /* Top bar */
    .topbar{position:sticky;top:0;z-index:50;background:var(--card);border-bottom:1px solid var(--border);padding:10px 12px;}
    .topbar-inner{max-width:820px;margin:0 auto;display:flex;align-items:center;gap:10px;}
    .icon-btn{width:42px;height:42px;border-radius:14px;border:1px solid var(--border);background:#fff;cursor:pointer;display:grid;place-items:center;}
    .icon-btn:active{transform:translateY(1px)}
    .brand-pill{flex:1;display:flex;align-items:center;justify-content:center;}
    .brand-pill span{border:1px solid var(--border);border-radius:999px;padding:6px 14px;font-weight:700;background:#fff;font-size:14px;}
    .hamburger{width:18px;height:12px;position:relative;}
    .hamburger::before,.hamburger::after,.hamburger div{content:"";position:absolute;left:0;right:0;height:2px;background:#111;border-radius:2px;}
    .hamburger::before{top:0}
    .hamburger div{top:5px}
    .hamburger::after{bottom:0}
    .search-ico{width:18px;height:18px;border:2px solid #111;border-radius:50%;position:relative;}
    .search-ico::after{content:"";position:absolute;width:9px;height:2px;background:#111;right:-7px;bottom:-3px;transform:rotate(45deg);border-radius:2px;}

    /* Drawer */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.30);z-index:60;display:none;}
    .drawer{
      position:fixed;top:0;left:0;height:100%;width:320px;max-width:86vw;
      background:#fff;z-index:61;transform:translateX(-110%);
      transition:transform .22s ease;box-shadow:var(--shadow);
      padding:16px;display:flex;flex-direction:column;gap:12px;
    }
    .drawer.open{transform:translateX(0)}
    .overlay.open{display:block}
    .drawer-head{display:flex;align-items:center;justify-content:space-between}
    .drawer-title{font-weight:800}
    .close-x{width:40px;height:40px;border-radius:14px;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:18px;line-height:1;}
    .menu-item{border:1px solid var(--border);border-radius:14px;padding:12px;font-weight:700;background:#fff;}
    .small{font-size:12px;color:rgba(0,0,0,.65)}

    /* Page */
    .wrap{max-width:820px;margin:16px auto;padding:0 12px 28px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;}
    .logo{display:flex;justify-content:center;margin:8px 0 10px;}
    .logo img{height:44px;max-width:100%;object-fit:contain}
    h1{margin:0 0 12px;font-size:28px}

    .grid{display:grid;gap:12px}
    .row{display:grid;gap:10px}
    @media(min-width:760px){.row.two{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:13px;font-weight:800;margin:0 0 6px}

    input,select{
      width:100%;
      height:var(--control-h);
      padding:0 12px;
      border-radius:var(--control-radius);
      border:1px solid rgba(0,0,0,.16);
      background:#fff;outline:none;
      font-size:var(--control-font);
    }
    input:focus,select:focus{border-color:#111}

    .inline{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border:1px solid var(--border);
      border-radius:14px;background:#fff;
      height:var(--control-h);
    }
    .inline input{width:auto;height:auto;padding:0;border:0}

    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:4px}
    .btn{padding:12px 14px;border-radius:14px;border:0;cursor:pointer;background:#111;color:#fff;font-weight:900;}
    .btn.secondary{background:#f2f2f2;color:#111;border:1px solid rgba(0,0,0,.12)}
    .price{font-size:18px;font-weight:900}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    .meta{font-size:13px;color:rgba(0,0,0,.70);margin-top:8px}

    /* Route panel */
    .route-panel{background:#efefef;border-radius:18px;padding:12px;}
    .route-title{text-align:center;font-size:24px;font-weight:900;margin:0 0 10px;}

    .route-box{
      position:relative;border:2px solid var(--green);border-radius:20px;background:#fff;
      padding:6px;display:grid;gap:6px;
    }
    .route-row{display:flex;align-items:center;gap:8px;}
    .route-dot{width:10px;height:10px;border-radius:50%;flex:0 0 12px;background:#bbb;border:1px solid #eee;}
    .route-dot.start{background:#5b5bff;}
    .route-dot.end{background:#21a366;}

    .field{
      flex:1;
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--fieldBorder);
      background:var(--field);
      border-radius:var(--control-radius);
      padding:0 8px;
      height:var(--control-h);
      min-width:0;
      position:relative;
    }
    .field .glass{
      width:18px;height:18px;border:2px solid #111;border-radius:50%;
      position:relative;flex:0 0 18px;opacity:.85;
    }
    .field .glass::after{
      content:"";position:absolute;width:9px;height:2px;background:#111;
      right:-7px;bottom:-3px;transform:rotate(45deg);border-radius:2px;
    }
    .field input{
      border:0 !important;
      padding:0 !important;
      outline:none !important;
      background:transparent;
      height:100%;
      font-size:var(--control-font);
    }

    .icon-square{
      width:var(--control-h);height:var(--control-h);
      border-radius:11px;border:1px solid rgba(0,0,0,.14);
      background:#f3f3f3;cursor:pointer;
      display:grid;place-items:center;font-size:14px;
      flex:0 0 var(--control-h);
    }

    .side-buttons{display:flex;flex-direction:column;gap:-8px;margin-left:-10px;}

    .swap-float{
      position:absolute;right:-35px;top:50%;transform:translateY(-50%);
      width:38px;height:38px;border-radius:16px;border:1px solid rgba(0,0,0,.14);
      background:#fff;cursor:pointer;box-shadow:0 10px 18px rgba(0,0,0,.12);font-size:16px;
    }

    /* ‚úÖ Autocomplete dropdown */
    .suggest-wrap{ position:relative; flex:1; min-width:0; }
    .suggest-list{
      position:absolute;left:0;right:0;top:calc(var(--control-h) + 6px);
      background:#fff;border:1px solid rgba(0,0,0,.14);border-radius:14px;
      box-shadow:0 14px 28px rgba(0,0,0,.14);
      overflow:hidden;z-index:9999;max-height:240px;overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }
    .suggest-item{padding:10px 12px;font-size:14px;cursor:pointer;border-top:1px solid rgba(0,0,0,.08);}
    .suggest-item:first-child{border-top:0;}
    .suggest-item:hover{background:#f4f4f4;}
    .suggest-muted{opacity:.7;font-size:12px;margin-top:2px;}

    /* ‚úÖ Bolt-style Map Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:#fff;z-index:200;
      display:none;flex-direction:column;
    }
    .modal-backdrop.open{display:flex;}

    .picker-top{display:flex;align-items:center;gap:10px;padding:14px 14px 10px;}
    .picker-back{
      width:44px;height:44px;border-radius:22px;border:0;background:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,.10);
      cursor:pointer;font-size:20px;
    }

    .picker-search{
      flex:1;display:flex;align-items:center;gap:10px;
      background:#fff;border:2px solid #0f6c3b;border-radius:18px;padding:10px 12px;
      box-shadow:0 10px 18px rgba(0,0,0,.10);max-width:520px;
    }
    .picker-search .glass{width:18px;height:18px;border:2px solid #111;border-radius:50%;position:relative;flex:0 0 18px;opacity:.9;}
    .picker-search .glass::after{content:"";position:absolute;width:9px;height:2px;background:#111;right:-7px;bottom:-3px;transform:rotate(45deg);border-radius:2px;}
    .picker-search input{border:0 !important;outline:none !important;background:transparent !important;padding:0 !important;font-size:18px;width:100%;height:auto;}
    .picker-search .search-btn{width:38px;height:38px;border-radius:14px;border:0;background:#f2f2f2;cursor:pointer;display:grid;place-items:center;font-size:18px;}

    /* ‚úÖ map wrapper FIX (no white gap) */
    .picker-map-wrap{
      position:relative;
      flex:1;
      display:flex;
      min-height:0;
    }
    #pickerMap{
      width:100%;
      height:100%;
      min-height:0;
    }

    /* ‚úÖ fixed pin */
    .center-pin{
      position:absolute;left:50%;top:50%;
      width:26px;height:44px;
      transform:translate(-50%,-100%);
      z-index:500;pointer-events:none;
    }
    .center-pin::before{
      content:"";position:absolute;left:50%;top:0;transform:translateX(-50%);
      width:26px;height:26px;border-radius:50%;
      background:#1f7a3a;box-shadow:0 12px 22px rgba(0,0,0,.25);
    }
    .center-pin::after{
      content:"";position:absolute;left:50%;top:22px;transform:translateX(-50%);
      width:6px;height:22px;border-radius:0 0 6px 6px;background:#1f7a3a;
    }
    .center-pin span{
      position:absolute;left:50%;top:8px;transform:translateX(-50%);
      width:10px;height:10px;border-radius:50%;background:#fff;
    }

    .picker-bottom{padding:12px 14px 18px;background:#fff;box-shadow:0 -16px 30px rgba(0,0,0,.10);}
    .picked-address{font-size:20px;font-weight:900;margin:6px 0 10px;}
    .confirm-btn{
      width:100%;border:0;border-radius:18px;padding:16px 16px;
      background:#2f7d32;color:#fff;font-weight:900;font-size:18px;cursor:pointer;
    }
    .confirm-btn:active{transform:translateY(1px)}

    .whatsapp-note{color:red;}
  </style>
</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="topbar-inner">
      <button class="icon-btn" type="button" aria-label="Menu" onclick="openMenu()">
        <span class="hamburger"><div></div></span>
      </button>
      <div class="brand-pill"><span>YmaanyGo</span></div>
      <button class="icon-btn" type="button" aria-label="Zoeken" onclick="goSearch()">
        <span class="search-ico"></span>
      </button>
    </div>
  </div>

  <!-- Drawer -->
  <div id="overlay" class="overlay" onclick="closeMenu()"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div class="drawer-title">Menu</div>
      <button class="close-x" type="button" onclick="closeMenu()">√ó</button>
    </div>
    <a class="menu-item" href="index.html" onclick="closeMenu()">Home</a>
    <a class="menu-item" href="contact.html" onclick="closeMenu()">contact</a>
    <a class="menu-item" href="taxi.html" onclick="closeMenu()">Taxi boeken</a>
    <a class="menu-item" href="#" onclick="closeMenu(); goSearch(); return false;">Zoeken</a>
    <div class="small" style="margin-top:auto;">Indicatieve prijs. Definitieve bevestiging via WhatsApp.</div>
  </aside>

  <!-- Page -->
  <div class="wrap">
    <div id="taxi" class="card">
      <div class="logo"><img src="./logo.jpeg" alt="YmaanyGo logo"></div>
      <h1>Taxi boeken</h1>

      <!-- Route UI -->
      <div class="route-panel">
        <div class="route-title">Waar wil je heen?</div>

        <div class="route-box">
          <div class="route-row">
            <div class="route-dot start"></div>

            <div class="field">
              <span class="glass"></span>

              <!-- ‚úÖ autocomplete wrapper -->
              <div class="suggest-wrap">
                <input id="from" type="text" placeholder="Ophaallocatie" autocomplete="off" required>
                <div id="from-suggest" class="suggest-list hidden"></div>
              </div>

              <button class="icon-square" type="button" title="Pin (Ophaal)" onclick="openPicker('from')">üìç</button>
            </div>

            <div class="side-buttons">
              <button class="icon-square" type="button" title="Extra stop (later)" onclick="alert('Later: extra stop');">Ôºã</button>
            </div>
          </div>

          <div class="route-row">
            <div class="route-dot end"></div>

            <div class="field">
              <span class="glass"></span>

              <!-- ‚úÖ autocomplete wrapper -->
              <div class="suggest-wrap">
                <input id="to" type="text" placeholder="Bestemming" autocomplete="off" required>
                <div id="to-suggest" class="suggest-list hidden"></div>
              </div>

              <button class="icon-square" type="button" title="Pin (Bestemming)" onclick="openPicker('to')">üìç</button>
            </div>

            <div class="side-buttons">
              <button class="icon-square" type="button" title="Route" onclick="openRoute()">üß≠</button>
            </div>
          </div>

          <button class="swap-float" type="button" title="Omwisselen" onclick="swapRoute()">‚áÖ</button>
        </div>

        <!-- Huidige locatie -->
        <div style="margin-top:10px;">
          <button type="button"
                  onclick="useCurrentAsFrom()"
                  style="display:flex;align-items:center;gap:10px;background:transparent;border:0;
                         font-size:16px;font-weight:800;color:#111;cursor:pointer;">
            <span style="font-size:20px;">üìç</span>
            Huidige locatie
          </button>
        </div>
      </div>

      <form id="taxi-form" class="grid" onsubmit="return false;" style="margin-top:12px;">
        <div class="row two">
          <div>
            <label for="naam">Naam</label>
            <input type="text" id="naam" placeholder="Volledige naam" required>
          </div>
          <div>
            <label for="telefoon">Telefoonnummer</label>
            <input type="tel" id="telefoon" placeholder="06..." inputmode="tel" required>
          </div>
        </div>

        <div class="row two">
          <div>
            <label for="tijd">Ophaalmoment</label>
            <input type="datetime-local" id="tijd" required>
          </div>
          <div>
            <label for="auto">Voertuig</label>
            <select id="auto">
              <option value="Standaard">Standaard</option>
              <option value="Comfort">Comfort</option>
              <option value="Busje">Busje (8 pers.)</option>
            </select>
          </div>
        </div>

        <div class="row two">
          <div>
            <label for="reizigers">Aantal reizigers</label>
            <select id="reizigers">
              <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
              <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="inline">
              <input type="checkbox" id="retour" onchange="toggleRetour()">
              <strong>Retour</strong>
            </div>
          </div>
        </div>

        <div id="retourBlock" class="row hidden">
          <div>
            <label for="retour_tijd">Retour datum & tijd</label>
            <input type="datetime-local" id="retour_tijd">
          </div>
        </div>

        <div class="row">
          <div class="inline">
            <input type="checkbox" id="luchthaven" onchange="toggleLuchthaven()">
            <strong>Vanuit luchthaven?</strong>
          </div>
        </div>

        <div id="flightBlock" class="row hidden">
          <div>
            <label for="vluchtnummer">Vluchtnummer</label>
            <input type="text" id="vluchtnummer" placeholder="Bijv. KL1234">
          </div>
        </div>

        <div class="actions">
          <button class="btn" type="button" onclick="berekenPrijs()">Bereken mijn ritprijs</button>
          <button class="btn secondary" type="button" onclick="whatsappBoeking()">WhatsApp boeking</button>
          <span id="prijs" class="price"></span>
        </div>

        <div id="afstand" class="meta"></div>

        <div class="note whatsapp-note">
          Indicatieve prijs. Definitieve bevestiging via WhatsApp.
        </div>
      </form>
    </div>
  </div>

  <!-- Fullscreen Picker -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="picker-top">
      <button class="picker-back" type="button" onclick="closePicker()">‚Üê</button>

      <div class="picker-search">
        <span class="glass"></span>
        <input id="pickerSearchInput" type="text" placeholder="Zoek een adres..." />
        <button class="search-btn" type="button" onclick="pickerSearch()">üîé</button>
      </div>
    </div>

    <!-- ‚úÖ wrapper fix -->
    <div class="picker-map-wrap">
      <div id="pickerMap"></div>
      <div class="center-pin" aria-hidden="true"><span></span></div>
    </div>

    <div class="picker-bottom">
      <div id="pickedAddress" class="picked-address">‚Äî</div>
      <button id="confirmBtn" class="confirm-btn" type="button" onclick="pickerConfirm()">Bevestigen</button>
    </div>
  </div>

  <script>
    // ===== MENU =====
    function openMenu(){
      document.getElementById('overlay').classList.add('open');
      document.getElementById('drawer').classList.add('open');
      document.getElementById('drawer').setAttribute('aria-hidden','false');
    }
    function closeMenu(){
      document.getElementById('overlay').classList.remove('open');
      document.getElementById('drawer').classList.remove('open');
      document.getElementById('drawer').setAttribute('aria-hidden','true');
    }
    function goSearch(){
      closeMenu();
      document.getElementById('taxi').scrollIntoView({behavior:'smooth', block:'start'});
      setTimeout(()=>document.getElementById('from').focus(), 250);
    }

    // ===== Helpers =====
    function pad2(n){ return String(n).padStart(2,'0'); }
    function toLocalDateTimeValue(d){
      return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate()) +
             "T" + pad2(d.getHours()) + ":" + pad2(d.getMinutes());
    }

    // ‚úÖ ŸÖŸÜÿπ ŸàŸÇÿ™ ŸÖÿßÿ∂Ÿä (ÿ≠ÿßÿ±ÿ≥ ŸÖŸÜÿ∑ŸÇŸä)
    function parseLocalDateTime(v){
      if(!v) return null;
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }
    function isPastPickup(tijdValue, bufferMinutes = 15){
      const d = parseLocalDateTime(tijdValue);
      if(!d) return true;
      const now = new Date();
      now.setMinutes(now.getMinutes() + bufferMinutes);
      return d.getTime() < now.getTime();
    }

    function setMinDateTimes(){
      const now = new Date();
      now.setMinutes(now.getMinutes() + 15);
      const minVal = toLocalDateTimeValue(now);
      document.getElementById('tijd').min = minVal;
      document.getElementById('retour_tijd').min = minVal;
    }
    setMinDateTimes();
    window.addEventListener("focus", setMinDateTimes); // ‚úÖ Ÿäÿ≠ÿØÿ´ min ÿπŸÜÿØ ÿßŸÑÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿµŸÅÿ≠ÿ©

    // ===== Toggles =====
    function toggleRetour(){
      const on = document.getElementById('retour').checked;
      const block = document.getElementById('retourBlock');
      const field = document.getElementById('retour_tijd');
      if(on){ block.classList.remove('hidden'); field.required = true; }
      else { block.classList.add('hidden'); field.required = false; field.value=""; }
    }
    function toggleLuchthaven(){
      const on = document.getElementById('luchthaven').checked;
      const block = document.getElementById('flightBlock');
      const field = document.getElementById('vluchtnummer');
      if(on){ block.classList.remove('hidden'); field.required = true; }
      else { block.classList.add('hidden'); field.required = false; field.value=""; }
    }

    // ===== Swap =====
    function swapRoute(){
      const a = document.getElementById('from');
      const b = document.getElementById('to');
      const tmp = a.value;
      a.value = b.value;
      b.value = tmp;
    }

    // ===== Geocode / Reverse (Nominatim) =====
    const NOMINATIM_BASE = "https://nominatim.openstreetmap.org";
    const NOMINATIM_EMAIL = ""; // optional

    async function geocode(q){
      const url = NOMINATIM_BASE + "/search?format=json&limit=1&countrycodes=nl&addressdetails=1" +
                  (NOMINATIM_EMAIL ? ("&email=" + encodeURIComponent(NOMINATIM_EMAIL)) : "") +
                  "&q=" + encodeURIComponent(q);
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      const data = await res.json();
      if(!data || !data[0]) return null;
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }

    async function reverseGeocode(lat, lon){
      const url = NOMINATIM_BASE + `/reverse?format=json&zoom=18&lat=${lat}&lon=${lon}&addressdetails=1` +
                  (NOMINATIM_EMAIL ? ("&email=" + encodeURIComponent(NOMINATIM_EMAIL)) : "");
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      const data = await res.json();
      if(!data || !data.address) return null;

      const a = data.address;
      const road = a.road || a.pedestrian || "";
      const house = a.house_number || "";
      const city = a.city || a.town || a.village || "";
      const postcode = a.postcode || "";

      if(!road || !city) return null;

      const line = `${road} ${house}`.trim();
      const full = `${line}, ${postcode ? postcode + " " : ""}${city}, Nederland`
        .trim().replace(/\s+/g,' ');
      return full;
    }

    // ===== Distance (OSRM) =====
    async function routeDistanceKm(a, b){
      const url = `https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`;
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      const data = await res.json();
      if(!data || data.code !== "Ok" || !data.routes || !data.routes[0]) return null;
      return { km: data.routes[0].distance/1000, minutes: data.routes[0].duration/60 };
    }

    // ===== Pricing =====
    const START_TARIEF = 5.00;
    const PER_KM_STANDAARD = 2.00;
    const PER_KM_BUSJE = 2.50;
    const COMFORT_TOESLAG = 7.00;

    async function berekenPrijs(){
      const van = document.getElementById('from').value.trim();
      const naar = document.getElementById('to').value.trim();
      const voertuig = document.getElementById('auto').value;
      const retour = document.getElementById('retour').checked;

      // ‚úÖ ŸÖŸÜÿπ ÿßŸÑÿ≠ÿ¨ÿ≤ ŸÅŸä ÿßŸÑŸÖÿßÿ∂Ÿä (ÿ≠ÿ™Ÿâ ŸÑŸà min ÿßŸÜŸÉÿ≥ÿ±)
      const tijd = document.getElementById('tijd').value;
      if(isPastPickup(tijd, 15)){
        alert("‚ùå ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ≠ÿ¨ÿ≤ ŸÅŸä ÿßŸÑŸÖÿßÿ∂Ÿä. ÿßÿÆÿ™ÿ± ŸàŸÇÿ™Ÿãÿß ÿ®ÿπÿØ ÿßŸÑÿ¢ŸÜ ÿ®ŸÄ 15 ÿØŸÇŸäŸÇÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ.");
        document.getElementById('prijs').innerText = "";
        document.getElementById('afstand').innerText = "";
        return;
      }

      // ‚úÖ retour ŸÑÿßÿ≤ŸÖ ÿ®ÿπÿØ ÿßŸÑÿ∞Ÿáÿßÿ®
      if(retour){
        const retourTijd = document.getElementById('retour_tijd').value;
        const td  = parseLocalDateTime(tijd);
        const rtd = parseLocalDateTime(retourTijd);
        if(!rtd || rtd.getTime() <= td.getTime()){
          alert("‚ùå ŸàŸÇÿ™ ÿßŸÑÿ±ÿ¨ÿπÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ®ÿπÿØ ŸàŸÇÿ™ ÿßŸÑÿ∞Ÿáÿßÿ®.");
          return;
        }
      }

      if(!van || !naar){ alert("Vul Ophaallocatie en Bestemming in."); return; }
      if(retour && !document.getElementById('retour_tijd').value){ alert("Vul Retour datum & tijd in."); return; }
      if(document.getElementById('luchthaven').checked && !document.getElementById('vluchtnummer').value.trim()){
        alert("Vul het vluchtnummer in."); return;
      }

      document.getElementById('prijs').innerText = "Bezig...";
      document.getElementById('afstand').innerText = "";

      const A = await geocode(van);
      const B = await geocode(naar);
      if(!A || !B){
        alert("‚ùó ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ∫Ÿäÿ± Ÿàÿßÿ∂ÿ≠. ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿØÿ®Ÿàÿ≥ Ÿàÿ≠ÿØŸëÿØ ÿßŸÑŸÖŸÉÿßŸÜ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©.");
        document.getElementById('prijs').innerText = "";
        return;
      }

      const r = await routeDistanceKm(A, B);
      if(!r){ alert("Kon afstand niet berekenen."); document.getElementById('prijs').innerText = ""; return; }

      const perKm = (voertuig === "Busje") ? PER_KM_BUSJE : PER_KM_STANDAARD;

      let prijs = START_TARIEF + (r.km * perKm);
      if (voertuig === "Comfort") prijs += COMFORT_TOESLAG;
      if (retour) prijs = prijs * 2;

      document.getElementById('prijs').innerText = "‚Ç¨ " + prijs.toFixed(2);
      document.getElementById('afstand').innerText =
        `Afstand: ${r.km.toFixed(1)} km ‚Ä¢ Duur: ${Math.round(r.minutes)} min`;
    }

    // ===== Validation =====
    function isValidNLPhone(v){
      const s = v.replace(/\s+/g,'').trim();
      return /^(0\d{9}|\+31\d{9})$/.test(s);
    }

    // ===== WhatsApp booking =====
    function whatsappBoeking(){
      const naam = document.getElementById('naam').value.trim();
      const tel = document.getElementById('telefoon').value.trim();
      const tijd = document.getElementById('tijd').value;

      const van = document.getElementById('from').value.trim();
      const naar = document.getElementById('to').value.trim();

      const voertuig = document.getElementById('auto').value;
      const reizigers = document.getElementById('reizigers').value;
      const retour = document.getElementById('retour').checked;
      const luchthaven = document.getElementById('luchthaven').checked;

      const retourTijd = document.getElementById('retour_tijd').value;
      const vluchtnummer = document.getElementById('vluchtnummer').value.trim();

      const prijs = document.getElementById('prijs').innerText || "Nog niet berekend";
      const afstandInfo = document.getElementById('afstand').innerText || "";

      // ‚úÖ ŸÖŸÜÿπ ÿßŸÑÿ≠ÿ¨ÿ≤ ŸÅŸä ÿßŸÑŸÖÿßÿ∂Ÿä
      if(isPastPickup(tijd, 15)){
        alert("‚ùå ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ≠ÿ¨ÿ≤ ŸÅŸä ÿßŸÑŸÖÿßÿ∂Ÿä. ÿßÿÆÿ™ÿ± ŸàŸÇÿ™Ÿãÿß ÿ®ÿπÿØ ÿßŸÑÿ¢ŸÜ ÿ®ŸÄ 15 ÿØŸÇŸäŸÇÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ.");
        return;
      }

      // ‚úÖ retour ŸÑÿßÿ≤ŸÖ ÿ®ÿπÿØ ÿßŸÑÿ∞Ÿáÿßÿ®
      if(retour){
        const td  = parseLocalDateTime(tijd);
        const rtd = parseLocalDateTime(retourTijd);
        if(!rtd || rtd.getTime() <= td.getTime()){
          alert("‚ùå ŸàŸÇÿ™ ÿßŸÑÿ±ÿ¨ÿπÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ®ÿπÿØ ŸàŸÇÿ™ ÿßŸÑÿ∞Ÿáÿßÿ®.");
          return;
        }
      }

      if(!naam || !tel || !tijd || !van || !naar){ alert("Vul alle verplichte velden in."); return; }
      if(!isValidNLPhone(tel)){ alert("Telefoonnummer is ongeldig. Gebruik 06xxxxxxxx of +31xxxxxxxxx."); return; }
      if(retour && !retourTijd){ alert("Vul Retour datum & tijd in."); return; }
      if(luchthaven && !vluchtnummer){ alert("Vul het vluchtnummer in."); return; }

      const bericht =
`Nieuwe taxi boeking:
Naam: ${naam}
Telefoon: ${tel}
Van: ${van}
Naar: ${naar}
Ophaalmoment: ${tijd}
Voertuig: ${voertuig}
Aantal reizigers: ${reizigers}
Retour: ${retour ? "Ja" : "Nee"}
${retour ? "Retour datum & tijd: " + retourTijd : ""}
Luchthaven: ${luchthaven ? "Ja" : "Nee"}
${luchthaven ? "Vluchtnummer: " + vluchtnummer : ""}
${afstandInfo ? afstandInfo : ""}
Prijs: ${prijs}`;

      const whatsappNummer = "31633337184";
      const url = "https://wa.me/" + whatsappNummer + "?text=" + encodeURIComponent(bericht);
      window.open(url, "_blank");
    }

    // ===== Open route: Apple on iPhone/Mac, Google others =====
    async function openRoute(){
      const origin = document.getElementById('from').value.trim();
      const destination = document.getElementById('to').value.trim();
      if(!origin || !destination){ alert("Vul Ophaallocatie en Bestemming in."); return; }

      const A = await geocode(origin);
      const B = await geocode(destination);
      if(!A || !B){ alert("‚ùó ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ∫Ÿäÿ± Ÿàÿßÿ∂ÿ≠. ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿØÿ®Ÿàÿ≥ Ÿàÿ≠ÿØŸëÿØ ÿßŸÑŸÖŸÉÿßŸÜ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©."); return; }

      const isApple = /iPhone|iPad|iPod|Macintosh/.test(navigator.userAgent);

      if(isApple){
        window.open(
          "https://maps.apple.com/?saddr=" + encodeURIComponent(origin) +
          "&daddr=" + encodeURIComponent(destination) +
          "&dirflg=d",
          "_blank"
        );
      } else {
        window.open(
          "https://www.google.com/maps/dir/?api=1" +
          "&origin=" + encodeURIComponent(origin) +
          "&destination=" + encodeURIComponent(destination) +
          "&travelmode=driving",
          "_blank"
        );
      }
    }

    // ===== Set From = GPS =====
    async function useCurrentAsFrom(){
      if(!navigator.geolocation){ alert("ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ."); return; }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        const addr = await reverseGeocode(lat, lon);
        if(!addr){ alert("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿπŸÜŸàÿßŸÜ."); return; }
        document.getElementById('from').value = addr;
      }, () => {
        alert("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ.");
      });
    }

    // ===== Autocomplete (Nominatim) =====
    function debounce(fn, ms){
      let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
    }

    async function suggestAddresses(q){
      const url = NOMINATIM_BASE + "/search?format=json&limit=6&countrycodes=nl&addressdetails=1&q=" + encodeURIComponent(q);
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    }

    function formatSuggestion(it){
      const a = it.address || {};
      const road = a.road || a.pedestrian || a.footway || "";
      const house = a.house_number || "";
      const city = a.city || a.town || a.village || "";
      const postcode = a.postcode || "";

      const line1 = `${road} ${house}`.trim() || (it.display_name || "").split(",")[0];
      const line2 = `${postcode ? postcode + " " : ""}${city}`.trim();
      return { line1, line2 };
    }

    function setInputFromNominatim(fieldId, it){
      const a = it.address || {};
      const road = a.road || a.pedestrian || a.footway || "";
      const house = a.house_number || "";
      const city = a.city || a.town || a.village || "";
      const postcode = a.postcode || "";

      const line = `${(road + " " + house).trim()}, ${postcode ? postcode + " " : ""}${city}, Nederland`
        .replace(/\s+/g," ").trim();

      document.getElementById(fieldId).value = line || it.display_name || "";
    }

    function hideSuggest(fieldId){
      const box = document.getElementById(fieldId + "-suggest");
      if(!box) return;
      box.classList.add("hidden");
      box.innerHTML = "";
    }

    function showSuggest(fieldId, items){
      const box = document.getElementById(fieldId + "-suggest");
      if(!box) return;

      if(!items.length){ hideSuggest(fieldId); return; }

      box.innerHTML = items.map((it, idx) => {
        const t = formatSuggestion(it);
        const line2 = t.line2 ? `<div class="suggest-muted">${t.line2}</div>` : "";
        return `<div class="suggest-item" data-i="${idx}">
                  <div>${t.line1}</div>
                  ${line2}
                </div>`;
      }).join("");

      box.classList.remove("hidden");

      box.querySelectorAll(".suggest-item").forEach(el=>{
        el.addEventListener("mousedown", (e)=>{ e.preventDefault(); });
        el.addEventListener("click", ()=>{
          const it = items[Number(el.dataset.i)];
          setInputFromNominatim(fieldId, it);
          hideSuggest(fieldId);
        });
      });
    }

    function bindAutocomplete(fieldId){
      const input = document.getElementById(fieldId);
      const box = document.getElementById(fieldId + "-suggest");
      if(!input || !box) return;

      const run = debounce(async ()=>{
        const q = input.value.trim();
        if(q.length < 3){ hideSuggest(fieldId); return; }
        const items = await suggestAddresses(q);
        showSuggest(fieldId, items);
      }, 250);

      input.addEventListener("input", run);
      input.addEventListener("blur", ()=>{ setTimeout(()=>hideSuggest(fieldId), 150); });
      input.addEventListener("focus", ()=>{ if(input.value.trim().length >= 3) run(); });
      input.addEventListener("keydown", (e)=>{ if(e.key === "Escape") hideSuggest(fieldId); });
    }

    // ===== Picker Logic =====
    let pickerMap = null;
    let activeFieldId = "from";
    let currentAddressText = "‚Äî";
    let updating = false;

    function getPinLatLng(){
      const mapEl = document.getElementById('pickerMap');
      const pinEl = document.querySelector('.center-pin');
      const mapRect = mapEl.getBoundingClientRect();
      const pinRect = pinEl.getBoundingClientRect();

      const x = (pinRect.left + pinRect.width/2) - mapRect.left;
      const y = (pinRect.top + pinRect.height) - mapRect.top;

      return pickerMap.containerPointToLatLng([x, y]);
    }

    function openPicker(fieldId){
      activeFieldId = fieldId;

      const btn = document.getElementById('confirmBtn');
      btn.textContent = (fieldId === "from") ? "Ophaallocatie bevestigen" : "Bestemming bevestigen";

      document.getElementById('pickedAddress').textContent = "‚Äî";
      document.getElementById('pickerSearchInput').value = "";

      document.getElementById('modalBackdrop').classList.add('open');

      setTimeout(async () => {
        if(!pickerMap){
          pickerMap = L.map('pickerMap', { zoomControl: false });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap' }).addTo(pickerMap);
          pickerMap.on('moveend', onMapMoveEnd);
        }

        pickerMap.invalidateSize();
        setTimeout(()=>pickerMap.invalidateSize(), 300);

        const val = document.getElementById(activeFieldId).value.trim();
        if(val){
          const p = await geocode(val);
          if(p){
            pickerMap.setView([p.lat, p.lon], 17);
            await onMapMoveEnd();
            return;
          }
        }

        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(async (pos) => {
            pickerMap.setView([pos.coords.latitude, pos.coords.longitude], 17);
            await onMapMoveEnd();
          }, async () => {
            pickerMap.setView([52.3702, 4.8952], 14);
            await onMapMoveEnd();
          });
        } else {
          pickerMap.setView([52.3702, 4.8952], 14);
          await onMapMoveEnd();
        }
      }, 60);
    }

    function closePicker(){
      document.getElementById('modalBackdrop').classList.remove('open');
    }

    async function onMapMoveEnd(){
      if(!pickerMap || updating) return;
      updating = true;

      const p = getPinLatLng();
      const addr = await reverseGeocode(p.lat, p.lng);

      currentAddressText = addr || "ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ∫Ÿäÿ± Ÿàÿßÿ∂ÿ≠ ‚Äî ÿ≠ÿ±ŸëŸÉ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©";
      document.getElementById('pickedAddress').textContent = currentAddressText;

      updating = false;
    }

    async function pickerSearch(){
      const q = document.getElementById('pickerSearchInput').value.trim();
      if(!q){ return; }
      const p = await geocode(q);
      if(!p){
        alert("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿπŸÜŸàÿßŸÜ. ÿ¨ÿ±Ÿëÿ® ŸÉÿ™ÿßÿ®ÿ© ÿ£Ÿà ÿ≠ÿ±ŸëŸÉ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©.");
        return;
      }
      pickerMap.setView([p.lat, p.lon], 17);
      await onMapMoveEnd();
    }

    async function pickerConfirm(){
      if(!pickerMap){ closePicker(); return; }

      const p = getPinLatLng();
      const addr = await reverseGeocode(p.lat, p.lng);

      if(!addr){
        alert("ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ∫Ÿäÿ± Ÿàÿßÿ∂ÿ≠. ÿ≠ÿ±ŸëŸÉ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÇŸÑŸäŸÑÿßŸã ÿ´ŸÖ ÿ≠ÿßŸàŸÑ.");
        return;
      }
      document.getElementById(activeFieldId).value = addr;
      closePicker();
    }

    document.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' && document.getElementById('modalBackdrop').classList.contains('open')){
        e.preventDefault();
        pickerSearch();
      }
    });

    // ‚úÖ start autocomplete
    bindAutocomplete("from");
    bindAutocomplete("to");
  </script>
</body>
</html>
